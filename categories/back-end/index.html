<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />

    

    

    <title>Category: back-end | yuanxb blog</title>
    <meta name="author" content="yuanxb" />
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />

    
    <link rel="alternate" href="/atom.xml" title="yuanxb blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/images/favicon.ico">
    

    <style type="text/css">
    @font-face {
        font-family: 'icomoon';
        src: url("/fonts/icomoon.eot?q628ml");
        src: url("/fonts/icomoon.eot?q628ml#iefix") format('embedded-opentype'),
             url("/fonts/icomoon.ttf?q628ml") format('truetype'),
             url("/fonts/icomoon.woff?q628ml") format('woff'),
             url("/fonts/icomoon.svg?q628ml#icomoon") format('svg');
        font-weight: normal;
        font-style: normal;
    }
    </style>
    
<link rel="stylesheet" href="/css/style.css">


    <!--[if lt IE 9]><style type="text/css">.nav-inner {top:0;}.author-meta {position:static;top:0;}.search-form {height:36px;}</style><script type="text/javascript" src="https://unpkg.com/html5shiv@3.7.3/dist/html5shiv.min.js"></script><![endif]-->
<meta name="generator" content="Hexo 5.3.0"></head>
<body>

    <main class="app">
        <header id="header" class="header clearfix">
    <div id="nav" class="nav">
    <div class="nav-mobile">
        <button id="open-panel" class="open-panel nav-mobile-item"><i class="icon-documents"></i></button>
        <h1 class="nav-mobile-title nav-mobile-item">yuanxb blog</h1>
        <button id="open-menus" class="open-panel nav-mobile-item"><i class="icon-library"></i></button>
    </div>

    <nav id="nav-inner" class="nav-inner">
        
            <a class="nav-item" href="/">
                <span class="nav-text">首页</span>
            </a>
        
            <a class="nav-item active" href="/categories/back-end">
                <span class="nav-text">后端</span>
            </a>
        
            <a class="nav-item" href="/tags">
                <span class="nav-text">标签</span>
            </a>
        
            <a class="nav-item" href="/archives">
                <span class="nav-text">归档</span>
            </a>
        
            <a class="nav-item" href="/atom.xml">
                <span class="nav-text">订阅</span>
            </a>
        
            <a class="nav-item" href="/about">
                <span class="nav-text">关于</span>
            </a>
        
    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="https://github-yxb.github.io"></form>

        
        

        
        <div class="author-meta">
            
            <div class="author-avatar">
                <a href="/">
                    <img src="/images/avatar.jpg" title="YuanXiaobo">
                </a>
            </div>
            
            <div class="author-name">YuanXiaobo</div>
            <div class="author-work">程序员</div>
            <div class="author-location">
                <i class="icon-location vm"></i>
                <span class="vm">Shenzhen, China</span>
            </div>
            
            <div class="author-thread-wrap">
                <div class="author-threads clearfix">
                    
                        <a class="thread-item" href="https://github.com/github-yxb" target="_blank" rel="noopener">
                            <!-- Generated by IcoMoon.io -->
<svg viewBox="0 0 1024 1024" width="38" height="38" fill="currentColor">
<path d="M512 32.12c-265.004 0-479.88 220.23-479.88 492.090 0 217.446 137.536 401.684 328.202 466.81 23.994 4.498 32.778-10.712 32.778-23.78 0-11.782-0.428-42.632-0.642-83.764-133.466 29.778-161.744-65.984-161.744-65.984-21.852-56.772-53.344-71.982-53.344-71.982-43.49-30.636 3.214-29.992 3.214-29.992 48.202 3.428 73.482 50.772 73.482 50.772 42.846 75.196 112.258 53.558 139.68 40.918 4.284-31.706 16.71-53.558 30.42-65.77-106.474-12.426-218.516-54.63-218.516-243.152 0-53.772 18.638-97.69 49.274-131.966-4.928-12.426-21.424-62.556 4.714-130.252 0 0 40.276-13.282 131.966 50.344 38.348-10.926 79.266-16.282 120.184-16.496 40.704 0.214 81.836 5.57 120.184 16.496 91.692-63.626 131.752-50.344 131.752-50.344 26.136 67.698 9.64 117.828 4.714 130.252 30.636 34.492 49.274 78.408 49.274 131.966 0 188.952-112.258 230.514-219.16 242.724 17.138 15.21 32.564 45.202 32.564 91.048 0 65.77-0.642 118.898-0.642 134.966 0 13.068 8.57 28.492 32.992 23.566 191.094-64.912 328.418-249.152 328.418-466.382 0-271.86-214.874-492.090-479.88-492.090z"></path>
</svg>

                        </a>
                    
                </div>
            </div>
            
        </div>
        
    </div>
</aside>

</header>

        <div id="content" class="content">
            <div id="wrapper" class="wrapper" style="max-width: 800px">
                
    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2020/12/13/translate_discord/">Discord为什么从Go切换到Rust</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://github-yxb.github.io/categories/back-end/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2020-12-13T12:12:29.000Z" itemprop="datePublished">2020-12-13</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag vm"></i>
    <a class="article-tag-link" href="/tags/%E7%BF%BB%E8%AF%91/" rel="tag">翻译</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p>Rust正在成为各个领域的一流语言.在Discord,我们已经在客户端和服务端看到了Rust的成功.例如,我们在客户端将其用于Go live的视频编码管道,在服务端用于Elixir NIFs.最近，我们通过将服务的实现从Go切换到Rust大大提高了服务性能。这篇文章描述了为什么重新实现服务很有意义，是怎么做到的，以及由此带来的性能提升.</p>
<h4 id="读取状态服务"><a href="#读取状态服务" class="headerlink" title="读取状态服务"></a>读取状态服务</h4><p>Discord是一家专注于产品的公司,所以我们先从一些关于产品的地方开始.我们从Go切换到Rust的服务是”读取状态”服务.它唯一的目的是跟踪你阅读了哪些频道和消息.读取状态服务.每一次你连接到Discord,每一次发送消息和每一次阅读消息都会访问读取状态.简单点说,读取状态服务是个热点.我们想确保Discord始终都能保持快速响应，所以我们需要确保读取状态服务足够快.</p>
<p>在Go的实现中,读取状态服务是不支持产品要求的.它大部分时间都很快,但是每隔几分钟我们就会看到巨大的延迟峰值,这不利于用户体验.调查后,我们认为延收割峰值是由于Go的核心功能:内存模型和GC.</p>
<p>为什么Go不满足我们的性能目标<br>要解释Go为什么不满足我们的性能目标,我们首先要讨论服务的数据结构,规模,访问模式和结构.</p>
<p>我们用于存储读取状态信息的数据结构方便的称为”读取状态”.Discord有数十亿个读取状态.每个用户每个频道都有读取状态.每个读取状态有数个计数器需要被原子刷新，并且经常被置为0.例如,有一个计数器是你在一个频道中有多少@提醒.</p>
<p>为了得到更快的原子计数器刷新,每个读取状态服务都有一个读取状态的LRU缓存.每个缓存中有数百分个用户.每个缓存中有数千万的读取状态.每秒中有数十万个缓存要刷新.</p>
<p>对于持久性,我们使用Cassandra数据库集群备份缓存.当缓存被逐出时,我们提交你的读取状态到数据库.同时当读取状态更新时，我们会在30秒内提交数据库.每秒有数十万个数据库写入.</p>
<p>在下面的图片中,你可以看到Go服务的响应时间和系统cpu采样.你可能注意到,延迟和cpu峰值大约每2分钟出现一次.</p>
        
        <p class="article-more-link">
            <a href="/2020/12/13/translate_discord/#more">
                <span class="vm">阅读更多</span>
                <i class="icon-arrow-double-right vm"></i>    
            </a>
        </p>
        
        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2020/11/26/kbengine_login/">kbengine登录流程之存储登录记录</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://github-yxb.github.io/categories/back-end/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2020-11-26T12:12:29.000Z" itemprop="datePublished">2020-11-26</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag vm"></i>
    <a class="article-tag-link" href="/tags/kbengine/" rel="tag">kbengine</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p>kbengine的登录流程:<br>客户端调用引擎的login接口,接口有(username, passwd, datas)三个参数.其中datas为二进制流，可自定义内容.可将设备码，渠道号等信息放到这个字段中.</p>
<p>引擎在处理登陆时将datas保存</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Loginapp::login</span><span class="params">(Network::Channel* pChannel, MemoryStream&amp; s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	AUTO_SCOPED_PROFILE(<span class="string">&quot;login&quot;</span>);</span><br><span class="line"></span><br><span class="line">	COMPONENT_CLIENT_TYPE ctype;</span><br><span class="line">	CLIENT_CTYPE tctype = UNKNOWN_CLIENT_COMPONENT_TYPE;</span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">string</span> loginName;</span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">string</span> password;</span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">string</span> datas;</span><br><span class="line">	<span class="keyword">bool</span> forceInternalLogin = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 前端类别</span></span><br><span class="line">	s &gt;&gt; tctype;</span><br><span class="line">	ctype = <span class="keyword">static_cast</span>&lt;COMPONENT_CLIENT_TYPE&gt;(tctype);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 附带数据</span></span><br><span class="line">	s.readBlob(datas);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 帐号登录名</span></span><br><span class="line">	s &gt;&gt; loginName;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 密码</span></span><br><span class="line">	s &gt;&gt; password;</span><br><span class="line"></span><br><span class="line">	.........</span><br><span class="line"></span><br><span class="line">	ptinfos = <span class="keyword">new</span> PendingLoginMgr::PLInfos;</span><br><span class="line">	ptinfos-&gt;ctype = ctype;</span><br><span class="line">	ptinfos-&gt;datas = datas;</span><br><span class="line">	ptinfos-&gt;accountName = loginName;</span><br><span class="line">	ptinfos-&gt;password = password;</span><br><span class="line">	ptinfos-&gt;addr = pChannel-&gt;addr();</span><br><span class="line">	ptinfos-&gt;forceInternalLogin = forceInternalLogin;</span><br><span class="line">	pendingLoginMgr_.add(ptinfos);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(ctype &lt; UNKNOWN_CLIENT_COMPONENT_TYPE || ctype &gt;= CLIENT_TYPE_END)</span><br><span class="line">		ctype = UNKNOWN_CLIENT_COMPONENT_TYPE;</span><br><span class="line"></span><br><span class="line">	INFO_MSG(fmt::format(<span class="string">&quot;Loginapp::login: new client[&#123;0&#125;], loginName=&#123;1&#125;, datas=&#123;2&#125;.\n&quot;</span>,</span><br><span class="line">		COMPONENT_CLIENT_NAME[ctype], loginName, datas));</span><br><span class="line"></span><br><span class="line">	pChannel-&gt;extra(loginName);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 向dbmgr查询用户合法性</span></span><br><span class="line">	Network::Bundle* pBundle = Network::Bundle::createPoolObject(OBJECTPOOL_POINT);</span><br><span class="line">	(*pBundle).newMessage(DbmgrInterface::onAccountLogin);</span><br><span class="line">	(*pBundle) &lt;&lt; loginName &lt;&lt; password;</span><br><span class="line">	(*pBundle).appendBlob(datas);</span><br><span class="line">	dbmgrinfos-&gt;pChannel-&gt;send(pBundle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>随后在login中查询db返回并验证通过后，将信息打包发送至baseapp中:</p>
        
        <p class="article-more-link">
            <a href="/2020/11/26/kbengine_login/#more">
                <span class="vm">阅读更多</span>
                <i class="icon-arrow-double-right vm"></i>    
            </a>
        </p>
        
        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2019/11/29/gilabci/">使用Gitlab-CI构建Docker镜像</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://github-yxb.github.io/categories/back-end/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2019-11-29T12:12:29.000Z" itemprop="datePublished">2019-11-29</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag vm"></i>
    <a class="article-tag-link" href="/tags/gitlab-docker-ci/" rel="tag">gitlab, docker, ci</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p>Gitlab自带CI/CD工具，可以使用CI在代码推送的时候自动构建Docker镜像并推送到镜像仓库.<br>省略gitlab的安装.</p>
<h3 id="Gitlab-Runner"><a href="#Gitlab-Runner" class="headerlink" title="Gitlab-Runner:"></a>Gitlab-Runner:</h3><p>GitLab-Runner是配合GitLab-CI进行使用的。一般地，GitLab里面的每一个工程都会定义一个属于这个工程的软件集成脚本，用来自动化地完成一些软件集成工作。当这个工程的仓库代码发生变动时，比如有人push了代码，GitLab就会将这个变动通知GitLab-CI。这时GitLab-CI会找出与这个工程相关联的Runner，并通知这些Runner把代码更新到本地并执行预定义好的执行脚本。</p>
<h4 id="Runner类型"><a href="#Runner类型" class="headerlink" title="Runner类型"></a>Runner类型</h4><p>GitLab-Runner可以分类两种类型：Shared Runner（共享型）和Specific Runner（指定型）。</p>
<p>Shared Runner：这种Runner（工人）是所有工程都能够用的。只有系统管理员能够创建Shared Runner。</p>
<p>Specific Runner：这种Runner（工人）只能为指定的工程服务。拥有该工程访问权限的人都能够为该工程创建Shared Runner。</p>
<h3 id="步䯅"><a href="#步䯅" class="headerlink" title="步䯅"></a>步䯅</h3><p>安装Runner到目标机器上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L https:&#x2F;&#x2F;packages.gitlab.com&#x2F;install&#x2F;repositories&#x2F;runner&#x2F;gitlab-ci-multi-runner&#x2F;script.rpm.sh | sudo bash</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install gitlab-ci-multi-runner</span><br></pre></td></tr></table></figure>
<p>安装好gitlab-ci-multi-runner这个软件之后，我们就可以用它向GitLab-CI注册Runner了。</p>
<p>向GitLab-CI注册一个Runner需要两样东西：GitLab-CI的url和注册token。<br>其中，token是为了确定你这个Runner是所有工程都能够使用的Shared Runner还是具体某一个工程才能使用的Specific Runner。</p>
<p>执行下面的命令向gitlab注册runner:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ci-multi-runner register</span><br></pre></td></tr></table></figure>
<p>根据提示输入对应的信息，注册完成之后，GitLab-CI就会多出一条Runner记录</p>
<p>接下来在需要CI的项目下新建.gitlab-ci.yml文件，在其中写入相应的配置,下面是一个示例，在代码推送后会将工程打包为一个docker镜像，tag为分支名加最新的哈希值:</p>
        
        <p class="article-more-link">
            <a href="/2019/11/29/gilabci/#more">
                <span class="vm">阅读更多</span>
                <i class="icon-arrow-double-right vm"></i>    
            </a>
        </p>
        
        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2019/10/30/pybdind11/">使用pybind11导出c++接口</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://github-yxb.github.io/categories/back-end/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2019-10-30T12:12:29.000Z" itemprop="datePublished">2019-10-30</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag vm"></i>
    <a class="article-tag-link" href="/tags/pybind11-c-python/" rel="tag">pybind11, c++, python</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <ul>
<li><p>需求<br>如果需要在python代码中调用c++或者c语言写的功能，需要将c/c++的函数或者对象导出，有两个常用的选择:Cython和pybind11.</p>
</li>
<li><p>cython:<br>使用cython时，如果c/c++ 返回复合结构时，如:vector<int>,需要自己在cython代码中将结果转换为python对象,接口多时略显繁琐.</p>
</li>
<li><p>pybind11<br>使用pybind11只需包含它的头文件，定义导出的函数和类，然后编译成功。简单常用的stl对象也会自动转换为python对象.</p>
</li>
<li><p>示例</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pybind11/pybind11.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pybind11/stl.h&gt;</span></span></span><br><span class="line"><span class="keyword">namespace</span> py = pybind11;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ludogame.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">PYBIND11_MODULE(LudoGame, m)</span><br><span class="line">&#123;</span><br><span class="line">    py::class_&lt;LudoGame&gt;(m, <span class="string">&quot;LudoGame&quot;</span>)</span><br><span class="line">        .def(py::init&lt;&gt;())</span><br><span class="line">        .def(<span class="string">&quot;init&quot;</span>, &amp;LudoGame::init)</span><br><span class="line">        .def(<span class="string">&quot;roll&quot;</span>, &amp;LudoGame::roll)</span><br><span class="line">        .def(<span class="string">&quot;roll_again&quot;</span>, &amp;LudoGame::roll_again)</span><br><span class="line">        .def(<span class="string">&quot;move&quot;</span>, &amp;LudoGame::move)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
        
        <p class="article-more-link">
            <a href="/2019/10/30/pybdind11/#more">
                <span class="vm">阅读更多</span>
                <i class="icon-arrow-double-right vm"></i>    
            </a>
        </p>
        
        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2019/06/26/autobahn_websocket/">twisted中使用autobahn提供websocket服务</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://github-yxb.github.io/categories/back-end/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2019-06-26T12:12:29.000Z" itemprop="datePublished">2019-06-26</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag vm"></i>
    <a class="article-tag-link" href="/tags/twisted-websocket-autobahn/" rel="tag">twisted, websocket, autobahn</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p>Twisted网络框架没有提供关于websocket的功能，在现有的轮子中只有 autobahn-python 中提供了简单易用的基于twisted的websocket库.<br>如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">from autobahn.twisted.websocket import WebSocketServerProtocol, listenWS, WebSocketServerFactory</span><br><span class="line">from twisted.internet import reactor</span><br><span class="line"></span><br><span class="line">class WebsocketClient(WebSocketServerProtocol, TimeoutMixin):</span><br><span class="line">    def onOpen(self):</span><br><span class="line">        &quot;&quot;&quot;连接建立处理</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        pass</span><br><span class="line"></span><br><span class="line">    def onMessage(self, payload, isBinary):</span><br><span class="line">        self.sendMessage(b&#39;hello&#39;)</span><br><span class="line"></span><br><span class="line">    def onClose(self, wasClean, code, reason):</span><br><span class="line">        pass</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class WebSocketFactory(WebSocketServerFactory):</span><br><span class="line">    protocol &#x3D; WebsocketClient</span><br><span class="line"></span><br><span class="line">    def __init__(self, *args, **kwargs):</span><br><span class="line">        self.isSecure &#x3D; False</span><br><span class="line">        super().__init__(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">reactor.listenTCP(  # pylint: disable&#x3D;no-member</span><br><span class="line">    2312, WebSocketFactory()</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="易踩坑的地方"><a href="#易踩坑的地方" class="headerlink" title="易踩坑的地方"></a>易踩坑的地方</h3>
        
        <p class="article-more-link">
            <a href="/2019/06/26/autobahn_websocket/#more">
                <span class="vm">阅读更多</span>
                <i class="icon-arrow-double-right vm"></i>    
            </a>
        </p>
        
        
    </section>
</article>






            </div>
        </div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a>

    
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?bdf4ffe8348927e73c117fd0b3a5dc51";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    
</footer>

    </main>

    <script type="text/javascript" src="https://unpkg.com/jquery@1.9.1/jquery.min.js"></script>
    <script type="text/javascript">
    $(function() {
        var nodes = {
            nav: $('#nav'),
            aside: $('#aside'),
            asideInner: $('#aside-inner'),
            navInner: $('#nav-inner')
        };

        var doing = false;
        nodes.asideInner.on('webkitAnimationEnd mozAnimationEnd oAnimationEnd oanimationend animationend', function() {
            if (nodes.aside.hasClass('mobile-open')) {
                nodes.aside.removeClass('mobile-open');
            } else {
                nodes.aside.removeClass('mobile-close panel-show');
            }
            doing = false;
        });
        $('#open-panel, #aside-mask').on('click', function() {
            if (doing) {
                return;
            }

            if (nodes.aside.hasClass('panel-show')) {
                nodes.aside.addClass('mobile-close');
            } else {
                nodes.aside.addClass('mobile-open panel-show');
            }
        });
        $('#open-menus').on('click', function() {
            nodes.navInner.slideToggle('normal', slideDone);
        });

        if (window.innerWidth <= 960) {
            setTimeout(function() {
                nodes.navInner.slideUp('normal', slideDone);
            }, 3000);
        }

        function slideDone() {
            if (nodes.navInner.css('display') !== 'none') {
                nodes.navInner.css('display', '');
            }
        }

        $(window).on('resize', function() {
            if ($(this).width() > 960) {
                nodes.navInner.css('display', '');
            }
        });
    });
    </script>
    

</body>
</html>
